import pandas as pd
import numpy as np
import os


def validate_excel_sums_with_debug(file_path, sheet_name="correct"):
    """
    Excelãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ¤œè¨¼ã—ã€Aåˆ—ã®å€¤ã¨æ¨ªæ–¹å‘ã®åˆè¨ˆãŒä¸€è‡´ã™ã‚‹ã‹ç¢ºèªã™ã‚‹é–¢æ•°ã€‚
    è©³ç´°ãªãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’å‡ºåŠ›ã—ã¾ã™ã€‚

    Parameters:
    -----------
    file_path : str
        Excelãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹
    sheet_name : str, default="correct"
        æ¤œè¨¼å¯¾è±¡ã®ã‚·ãƒ¼ãƒˆå
    """
    try:
        # ğŸ” ãƒ‡ãƒãƒƒã‚°: ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿é–‹å§‹
        print("\n==== ğŸ” ãƒ‡ãƒãƒƒã‚°: ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿é–‹å§‹ ====")
        print(f"ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹: {file_path}")
        print(f"ã‚·ãƒ¼ãƒˆå: {sheet_name}")

        # Excelã‚’èª­ã¿è¾¼ã‚€
        df = pd.read_excel(file_path, sheet_name=sheet_name)

        # ğŸ” ãƒ‡ãƒãƒƒã‚°: ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿å®Œäº†
        print("\n==== ğŸ” ãƒ‡ãƒãƒƒã‚°: ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿å®Œäº† ====")
        print(f"ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã®å½¢çŠ¶: {df.shape} (è¡Œæ•°, åˆ—æ•°)")
        print("\næœ€åˆã®5è¡Œ:")
        print(df.head(5).to_string())

        # ğŸ” ãƒ‡ãƒãƒƒã‚°: ãƒ‡ãƒ¼ã‚¿å‹ã®ç¢ºèª
        print("\n==== ğŸ” ãƒ‡ãƒãƒƒã‚°: ãƒ‡ãƒ¼ã‚¿å‹ã®ç¢ºèª ====")
        print(df.dtypes)

        # ğŸ” ãƒ‡ãƒãƒƒã‚°: æ¬ æå€¤ã®ç¢ºèª
        print("\n==== ğŸ” ãƒ‡ãƒãƒƒã‚°: æ¬ æå€¤ã®ç¢ºèª ====")
        missing_values = df.isnull().sum()
        print(missing_values)

        # ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã®æƒ…å ±
        print("\n==== ğŸ” ãƒ‡ãƒãƒƒã‚°: ãƒ˜ãƒƒãƒ€ãƒ¼æƒ…å ± ====")
        print(f"ã‚«ãƒ©ãƒ å: {df.columns.tolist()}")

        # Aåˆ—ï¼ˆç·åˆè¨ˆï¼‰ã®ãƒ‡ãƒ¼ã‚¿
        total_A = df.iloc[:, 0]  # Aåˆ—ï¼ˆ1åˆ—ç›®ï¼‰

        # ğŸ” ãƒ‡ãƒãƒƒã‚°: Aåˆ—ã®å€¤
        print("\n==== ğŸ” ãƒ‡ãƒãƒƒã‚°: Aåˆ—ã®å€¤ ====")
        print(total_A.to_string())

        # Båˆ—ä»¥é™ã®ãƒ‡ãƒ¼ã‚¿ï¼ˆæ•°å€¤åŒ–ã—ã¦åˆè¨ˆï¼‰
        print("\n==== ğŸ” ãƒ‡ãƒãƒƒã‚°: Båˆ—ä»¥é™ã®ãƒ‡ãƒ¼ã‚¿å¤‰æ›å‰ ====")
        columns_B_onward = df.iloc[:, 1:]
        print(columns_B_onward.head(5).to_string())

        # æ•°å€¤åŒ–å‡¦ç†
        print("\n==== ğŸ” ãƒ‡ãƒãƒƒã‚°: æ•°å€¤åŒ–å‡¦ç† ====")
        columns_B_onward_numeric = columns_B_onward.apply(
            pd.to_numeric, errors="coerce"
        )
        print("æ•°å€¤åŒ–å¾Œã®ãƒ‡ãƒ¼ã‚¿:")
        print(columns_B_onward_numeric.head(5).to_string())

        # å„è¡Œã®åˆè¨ˆã‚’è¨ˆç®—
        total_other = columns_B_onward_numeric.sum(axis=1)

        # ğŸ” ãƒ‡ãƒãƒƒã‚°: æ¨ªæ–¹å‘ã®åˆè¨ˆ
        print("\n==== ğŸ” ãƒ‡ãƒãƒƒã‚°: æ¨ªæ–¹å‘ã®åˆè¨ˆ ====")
        print(total_other.to_string())

        # å·®åˆ†ã®è¨ˆç®—
        diff = total_A - total_other

        # ğŸ” ãƒ‡ãƒãƒƒã‚°: å·®åˆ†
        print("\n==== ğŸ” ãƒ‡ãƒãƒƒã‚°: Aåˆ—ã¨æ¨ªæ–¹å‘åˆè¨ˆã®å·®åˆ† ====")
        print(diff.to_string())

        # ä¸€è‡´ç¢ºèª - pandas Seriesã«å¤‰æ›
        is_match = pd.Series(np.isclose(total_A, total_other), index=total_A.index)

        # ğŸ” ãƒ‡ãƒãƒƒã‚°: ä¸€è‡´ç¢ºèªçµæœ
        print("\n==== ğŸ” ãƒ‡ãƒãƒƒã‚°: ä¸€è‡´ç¢ºèªçµæœ ====")
        print(is_match.to_string())

        # çµæœã®ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ä½œæˆ
        result_df = pd.DataFrame(
            {
                "Aåˆ—ã®å€¤": total_A,
                "æ¨ªæ–¹å‘ã®åˆè¨ˆ": total_other,
                "å·®åˆ†": diff,
                "ä¸€è‡´": is_match,
            }
        )

        # ğŸ” ãƒ‡ãƒãƒƒã‚°: æœ€çµ‚çµæœ
        print("\n==== ğŸ” ãƒ‡ãƒãƒƒã‚°: è¨ˆç®—ãƒã‚§ãƒƒã‚¯æœ€çµ‚çµæœ ====")
        print(result_df.to_string())

        # çµ±è¨ˆæƒ…å ±
        print("\n==== ğŸ” ãƒ‡ãƒãƒƒã‚°: çµ±è¨ˆæƒ…å ± ====")
        total_rows = len(result_df)
        match_rows = result_df["ä¸€è‡´"].sum()
        print(f"æ¤œè¨¼ç·è¡Œæ•°: {total_rows}")
        print(f"ä¸€è‡´ã—ãŸè¡Œæ•°: {match_rows} ({match_rows/total_rows*100:.1f}%)")
        print(
            f"ä¸ä¸€è‡´ã®è¡Œæ•°: {total_rows - match_rows} ({(total_rows - match_rows)/total_rows*100:.1f}%)"
        )

        # ä¸ä¸€è‡´ã®è¡Œã‚’æŠ½å‡º
        mismatch_rows = result_df[~result_df["ä¸€è‡´"]]

        if not mismatch_rows.empty:
            print("\n==== ğŸ” ãƒ‡ãƒãƒƒã‚°: ä¸ä¸€è‡´ã®è¡Œ ====")
            print(mismatch_rows.to_string())

            # ä¸ä¸€è‡´ã®è©³ç´°åˆ†æ
            print("\n==== ğŸ” ãƒ‡ãƒãƒƒã‚°: ä¸ä¸€è‡´ã®è©³ç´°åˆ†æ ====")
            for idx in mismatch_rows.index:
                print(f"\nè¡Œ {idx+1} ã®è©³ç´°åˆ†æ:")
                print(f"Aåˆ—ã®å€¤: {total_A[idx]}")
                print(f"æ¨ªæ–¹å‘ã®åˆè¨ˆ: {total_other[idx]}")
                print(f"å·®åˆ†: {diff[idx]}")

                # å„åˆ—ã®å€¤ã‚’è¡¨ç¤º
                print("å„åˆ—ã®å€¤:")
                row_values = columns_B_onward_numeric.iloc[idx]
                for col_idx, value in enumerate(row_values):
                    if pd.notna(value):
                        col_name = columns_B_onward.columns[col_idx]
                        contribution = (
                            (value / total_other[idx]) * 100
                            if total_other[idx] != 0
                            else 0
                        )
                        print(f"  {col_name}: {value} (å¯„ä¸ç‡: {contribution:.1f}%)")

        # å…ƒã®ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã¨è¨ˆç®—çµæœã‚’çµåˆ
        full_result = pd.concat(
            [df, result_df.rename(columns={"Aåˆ—ã®å€¤": "å…ƒã®Aåˆ—å€¤"})], axis=1
        )

        print("\n==== ğŸ” ãƒ‡ãƒãƒƒã‚°: å®Œå…¨ãªçµæœãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ  ====")
        print(full_result.head(10).to_string())

        return result_df

    except Exception as e:
        print(f"\nâŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}")
        import traceback

        traceback.print_exc()
        return None


# å‡¦ç†ã®ãƒ¡ã‚¤ãƒ³é–¢æ•°
def process_excel_validation(file_path, sheet_name="correct"):
    """
    Excelãƒ•ã‚¡ã‚¤ãƒ«ã®æ¤œè¨¼ã‚’å®Ÿè¡Œã—ã€çµæœã‚’å‡ºåŠ›ã™ã‚‹é–¢æ•°

    Parameters:
    -----------
    file_path : str
        Excelãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹
    sheet_name : str, default="correct"
        æ¤œè¨¼å¯¾è±¡ã®ã‚·ãƒ¼ãƒˆå
    """
    print("\n===== Excelæ¨ªè¡Œè¨ˆç®—æ¤œè¨¼å‡¦ç†ã®é–‹å§‹ =====")

    # ãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª
    if not os.path.exists(file_path):
        print(f"âŒ ã‚¨ãƒ©ãƒ¼: ãƒ•ã‚¡ã‚¤ãƒ« '{file_path}' ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")
        return

    print(f"âœ… ãƒ•ã‚¡ã‚¤ãƒ« '{file_path}' ã‚’å‡¦ç†ã—ã¾ã™")

    # æ¤œè¨¼å®Ÿè¡Œï¼ˆãƒ‡ãƒãƒƒã‚°æƒ…å ±ä»˜ãï¼‰
    result_df = validate_excel_sums_with_debug(file_path, sheet_name)

    if result_df is not None:
        # æ¤œè¨¼çµæœã®ã‚µãƒãƒªãƒ¼
        match_count = result_df["ä¸€è‡´"].sum()
        total_count = len(result_df)

        print("\n===== æ¤œè¨¼çµæœã‚µãƒãƒªãƒ¼ =====")
        print(f"âœ… æ¤œè¨¼å®Œäº†: åˆè¨ˆ {total_count} è¡Œ")
        print(f"âœ… ä¸€è‡´: {match_count} è¡Œ ({match_count/total_count*100:.1f}%)")
        print(
            f"âŒ ä¸ä¸€è‡´: {total_count - match_count} è¡Œ ({(total_count - match_count)/total_count*100:.1f}%)"
        )

        # ä¸ä¸€è‡´ãŒã‚ã‚‹å ´åˆã®å‡¦ç†
        if match_count < total_count:
            print("\nä¸ä¸€è‡´ã®è¡ŒãŒã‚ã‚Šã¾ã™ã€‚è©³ç´°ãªãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚")

            # ã“ã“ã§è¿½åŠ ã®å‡¦ç†ï¼ˆä¾‹: çµæœã®ä¿å­˜ãªã©ï¼‰ã‚’è¡Œã†ã“ã¨ã‚‚å¯èƒ½
        else:
            print("\nã™ã¹ã¦ã®è¡Œã§Aåˆ—ã®å€¤ã¨æ¨ªæ–¹å‘ã®åˆè¨ˆãŒä¸€è‡´ã—ã¦ã„ã¾ã™ã€‚ğŸ‘")

    print("\n===== Excelæ¨ªè¡Œè¨ˆç®—æ¤œè¨¼å‡¦ç†ã®çµ‚äº† =====")


if __name__ == "__main__":
    file_path = "C:\\Users\\yukik\\Desktop\\ex\\0225test_yokokei\\yokokei.xlsx"
    sheet_name = "correct"

    # æ¤œè¨¼å®Ÿè¡Œ
    process_excel_validation(file_path, sheet_name)

#0225_yokokeiæ¨ªç½«ã¨Aåˆ—ã®æ¯”è¼ƒPRO
