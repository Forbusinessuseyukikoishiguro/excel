import pandas as pd
import numpy as np
import os


def validate_excel_sums_with_company_cells(file_path, sheet_name="correct"):
    """
    Excelãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ¤œè¨¼ã—ã€Aåˆ—ã®å€¤ã¨æ¨ªæ–¹å‘ã®åˆè¨ˆãŒä¸€è‡´ã™ã‚‹ã‹ç¢ºèªã™ã‚‹é–¢æ•°ã€‚
    ä¸ä¸€è‡´ã®å ´åˆã¯ã€é–¢é€£ã™ã‚‹ä¼æ¥­ã‚»ãƒ«ã‚’ã€ŒA2 ã¨ B1ã€ã®å½¢å¼ã§å–å¾—ã—ã¾ã™ã€‚

    Parameters:
    -----------
    file_path : str
        Excelãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹
    sheet_name : str, default="correct"
        æ¤œè¨¼å¯¾è±¡ã®ã‚·ãƒ¼ãƒˆå

    Returns:
    --------
    tuple
        (result_df, company_pairs)
        result_df: æ¤œè¨¼çµæœã®ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ 
        company_pairs: ä¸ä¸€è‡´æ™‚ã®ä¼æ¥­ã‚»ãƒ«ãƒšã‚¢æƒ…å ±ã®ãƒªã‚¹ãƒˆ
    """
    try:
        # ãƒ‡ãƒãƒƒã‚°: ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿é–‹å§‹
        print(f"ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹: {file_path}")
        print(f"ã‚·ãƒ¼ãƒˆå: {sheet_name}")

        # ä¼æ¥­åã‚»ãƒ«ã‚’å–å¾—ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã®ã‚»ãƒ«ï¼‰
        df_header = pd.read_excel(
            file_path, sheet_name=sheet_name, header=None, nrows=1
        )
        company_cells = []
        for col_idx in range(1, len(df_header.columns)):
            col_letter = chr(65 + col_idx)  # B, C, D...
            company_cells.append(f"{col_letter}1")

        # Excelã‚’èª­ã¿è¾¼ã‚€ï¼ˆãƒ‡ãƒ¼ã‚¿éƒ¨åˆ†ï¼‰
        df = pd.read_excel(file_path, sheet_name=sheet_name)

        # Aåˆ—ï¼ˆç·åˆè¨ˆï¼‰ã®ãƒ‡ãƒ¼ã‚¿
        total_A = df.iloc[:, 0]  # Aåˆ—ï¼ˆ1åˆ—ç›®ï¼‰

        # Båˆ—ä»¥é™ã®ãƒ‡ãƒ¼ã‚¿ï¼ˆæ•°å€¤åŒ–ã—ã¦åˆè¨ˆï¼‰
        columns_B_onward = df.iloc[:, 1:]
        columns_B_onward_numeric = columns_B_onward.apply(
            pd.to_numeric, errors="coerce"
        )
        total_other = columns_B_onward_numeric.sum(axis=1)

        # å·®åˆ†ã®è¨ˆç®—
        diff = total_A - total_other

        # ä¸€è‡´ç¢ºèª - pandas Seriesã«å¤‰æ›
        is_match = pd.Series(np.isclose(total_A, total_other), index=total_A.index)

        # çµæœã®ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ä½œæˆ
        result_df = pd.DataFrame(
            {
                "Aåˆ—ã®å€¤": total_A,
                "æ¨ªæ–¹å‘ã®åˆè¨ˆ": total_other,
                "å·®åˆ†": diff,
                "ä¸€è‡´": is_match,
            }
        )

        # ä¸ä¸€è‡´ã®è¡Œã‚’æŠ½å‡ºã—ã¦ã€é–¢é€£ã™ã‚‹ä¼æ¥­ã‚»ãƒ«ã‚’å–å¾—
        mismatch_rows = result_df[~result_df["ä¸€è‡´"]]

        # ä¼æ¥­ã‚»ãƒ«ãƒšã‚¢æƒ…å ±ã‚’æ ¼ç´ã™ã‚‹ãƒªã‚¹ãƒˆ
        company_pairs = []

        if not mismatch_rows.empty:
            print("\nä¸ä¸€è‡´ã®è¡ŒãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚ä¼æ¥­ã‚»ãƒ«æƒ…å ±ã‚’å–å¾—ã—ã¾ã™ã€‚")

            for idx in mismatch_rows.index:
                row_num = (
                    idx + 1
                )  # ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆ0å§‹ã¾ã‚Šï¼‰ã‹ã‚‰è¡Œç•ªå·ï¼ˆ1å§‹ã¾ã‚Šï¼‰ã¸
                a_cell = f"A{row_num + 1}"  # ãƒ˜ãƒƒãƒ€ãƒ¼è¡ŒãŒã‚ã‚‹ãŸã‚+1

                # ä¼æ¥­åˆ—ã®æƒ…å ±
                for col_idx, company_cell in enumerate(company_cells):
                    if col_idx < len(columns_B_onward.columns):
                        cell_value = columns_B_onward_numeric.iloc[idx, col_idx]
                        if pd.notna(cell_value) and cell_value != 0:
                            # ã‚»ãƒ«ãƒšã‚¢æƒ…å ±ã‚’è¿½åŠ 
                            company_pairs.append(
                                {
                                    "a_cell": a_cell,
                                    "company_cell": company_cell,
                                    "a_value": total_A.iloc[idx],
                                    "company_value": cell_value,
                                    "row_index": idx,
                                }
                            )

        return result_df, company_pairs

    except Exception as e:
        print(f"\nâŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}")
        import traceback

        traceback.print_exc()
        return None, []


def process_excel_validation_with_companies(file_path, sheet_name="correct"):
    """
    Excelãƒ•ã‚¡ã‚¤ãƒ«ã®æ¤œè¨¼ã‚’å®Ÿè¡Œã—ã€çµæœã¨ä¸ä¸€è‡´æ™‚ã®ä¼æ¥­ã‚»ãƒ«æƒ…å ±ã‚’å‡ºåŠ›ã™ã‚‹é–¢æ•°

    Parameters:
    -----------
    file_path : str
        Excelãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹
    sheet_name : str, default="correct"
        æ¤œè¨¼å¯¾è±¡ã®ã‚·ãƒ¼ãƒˆå
    """
    print("\n===== Excelæ¨ªè¡Œè¨ˆç®—æ¤œè¨¼å‡¦ç†ã®é–‹å§‹ =====")

    # ãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª
    if not os.path.exists(file_path):
        print(f"âŒ ã‚¨ãƒ©ãƒ¼: ãƒ•ã‚¡ã‚¤ãƒ« '{file_path}' ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")
        return

    print(f"âœ… ãƒ•ã‚¡ã‚¤ãƒ« '{file_path}' ã‚’å‡¦ç†ã—ã¾ã™")

    # æ¤œè¨¼å®Ÿè¡Œ
    result_df, company_pairs = validate_excel_sums_with_company_cells(
        file_path, sheet_name
    )

    if result_df is not None:
        # æ¤œè¨¼çµæœã®ã‚µãƒãƒªãƒ¼
        match_count = result_df["ä¸€è‡´"].sum()
        total_count = len(result_df)

        print("\n===== æ¤œè¨¼çµæœã‚µãƒãƒªãƒ¼ =====")
        print(f"âœ… æ¤œè¨¼å®Œäº†: åˆè¨ˆ {total_count} è¡Œ")
        print(f"âœ… ä¸€è‡´: {match_count} è¡Œ ({match_count/total_count*100:.1f}%)")
        print(
            f"âŒ ä¸ä¸€è‡´: {total_count - match_count} è¡Œ ({(total_count - match_count)/total_count*100:.1f}%)"
        )

        # ä¸ä¸€è‡´ãŒã‚ã‚‹å ´åˆã®å‡¦ç†
        if match_count < total_count:
            print("\nä¸ä¸€è‡´ã®è¡ŒãŒã‚ã‚Šã¾ã™ã€‚")

            # ä¸ä¸€è‡´ã®è¡Œã”ã¨ã«ä¼æ¥­ã‚»ãƒ«æƒ…å ±ã‚’è¡¨ç¤º
            print("\n=== ã‚·ãƒ³ãƒ—ãƒ«ãªè¡¨è¨˜ ===")
            mismatch_row_indices = set()

            for pair in company_pairs:
                print(f"{pair['a_cell']} ã¨ {pair['company_cell']}")
                mismatch_row_indices.add(pair["row_index"])

            # ä¸ä¸€è‡´ã®è©³ç´°åˆ†æ
            print("\n=== ä¸ä¸€è‡´ã®è©³ç´°åˆ†æ ===")
            for idx in mismatch_row_indices:
                row_pairs = [p for p in company_pairs if p["row_index"] == idx]
                a_cell = row_pairs[0]["a_cell"] if row_pairs else f"A{idx+2}"
                a_value = (
                    row_pairs[0]["a_value"] if row_pairs else result_df.iloc[idx, 0]
                )
                sum_value = result_df.iloc[idx, 1]
                diff_value = result_df.iloc[idx, 2]

                print(f"\nè¡Œ {idx+2} ã®åˆ†æ:")
                print(f"Aåˆ—ã‚»ãƒ«: {a_cell}, å€¤: {a_value}")
                print(f"æ¨ªæ–¹å‘ã®åˆè¨ˆ: {sum_value}")
                print(f"å·®åˆ†: {diff_value}")

                if row_pairs:
                    print("é–¢é€£ã™ã‚‹ä¼æ¥­ã‚»ãƒ«:")
                    for pair in row_pairs:
                        print(f"  {pair['company_cell']}: {pair['company_value']}")
        else:
            print("\nã™ã¹ã¦ã®è¡Œã§Aåˆ—ã®å€¤ã¨æ¨ªæ–¹å‘ã®åˆè¨ˆãŒä¸€è‡´ã—ã¦ã„ã¾ã™ã€‚ğŸ‘")

    print("\n===== Excelæ¨ªè¡Œè¨ˆç®—æ¤œè¨¼å‡¦ç†ã®çµ‚äº† =====")

    # ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’è¿”ã™
    if result_df is None:
        return 9  # ã‚¨ãƒ©ãƒ¼
    elif match_count == total_count:
        return 0  # å…¨ã¦ä¸€è‡´
    else:
        return 1  # ä¸€éƒ¨ä¸ä¸€è‡´


if __name__ == "__main__":
    file_path = "C:\\Users\\yukik\\Desktop\\ex\\0225test_yokokei\\yokokei.xlsx"
    sheet_name = "correct"

    # æ¤œè¨¼å®Ÿè¡Œ
    status_code = process_excel_validation_with_companies(file_path, sheet_name)
    print(f"\nã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰: {status_code}")

#0225_23:22_æ¨ªç½«ã¨Aåˆ—ãŒä¸€è‡´ã™ã‚‹ã‹ç¢ºèªã™ã‚‹ã€‚ï¼†ä¼æ¥­åã‚’å–å¾—ã™ã‚‹ã‚³ãƒ¼ãƒ‰ï¼°ï¼²ï¼¯ï¼¯ï¼«
